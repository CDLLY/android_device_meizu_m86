From a1b63b28bd0446fc42426f69feb5a56a17c4e82e Mon Sep 17 00:00:00 2001
From: faust93 <monumentum@gmail.com>
Date: Sat, 15 Oct 2016 20:51:48 +0300
Subject: [PATCH] Hifi Settings [1/3]

Change-Id: I756d285753115da50f29b1b88d19e4d16a3f1360
---
 .../java/com/android/server/audio/AudioService.java    | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/services/core/java/com/android/server/audio/AudioService.java b/services/core/java/com/android/server/audio/AudioService.java
index 44df8f5..9a2a62b 100644
--- a/services/core/java/com/android/server/audio/AudioService.java
+++ b/services/core/java/com/android/server/audio/AudioService.java
@@ -133,6 +133,8 @@ import java.util.List;
 import java.util.NoSuchElementException;
 import java.util.Objects;
 
+import cyanogenmod.providers.CMSettings;
+
 /**
  * The implementation of the volume manager service.
  * <p>
@@ -719,6 +721,7 @@ public class AudioService extends IAudioService.Stub {
         mMediaFocusControl = new MediaFocusControl(mContext);
 
         readAndSetLowRamDevice();
+        MzReadAndSetHifiParam();
 
         // Call setRingerModeInt() to apply correct mute
         // state on streams affected by ringer mode.
@@ -845,6 +848,7 @@ public class AudioService extends IAudioService.Stub {
         AudioSystem.setParameters("restarting=true");
 
         readAndSetLowRamDevice();
+        MzReadAndSetHifiParam();
 
         // Restore device connection states
         synchronized (mConnectedDevices) {
@@ -5461,6 +5465,9 @@ public class AudioService extends IAudioService.Stub {
             if (!isUsb && device != AudioSystem.DEVICE_IN_WIRED_HEADSET) {
                 sendDeviceConnectionIntent(device, state, address, deviceName);
             }
+            if (device == 4 || device == 8) {
+                MzReadAndSetHifiParam();
+            }
         }
     }
 
@@ -6604,6 +6611,17 @@ public class AudioService extends IAudioService.Stub {
         }
     }
 
+    private void MzReadAndSetHifiParam() {
+        int hifiEnable = CMSettings.System.getInt(mContentResolver, CMSettings.System.HIFI_ENABLE, 0);
+        Log.d(TAG,"MzReadAndSetHifiParam: hifiEnable=" + hifiEnable);
+        if (hifiEnable == 1) {
+            String gainKeyPairs = "hifi_gain=" + CMSettings.System.getInt(mContentResolver, CMSettings.System.HIFI_MODE, 0);
+                    AudioSystem.setParameters("hifi_state=on");
+                    AudioSystem.setParameters(gainKeyPairs);
+                    Log.d(TAG, "MzReadAndSetHifiParam: hifi_state=on | " + gainKeyPairs);
+        }
+    }
+
     //======================
     // Audio policy callbacks from AudioSystem for dynamic policies
     //======================
-- 
1.9.3 (Apple Git-50)

