From 0ed6ae6ea76f1dff5d240c35ed2d949e00882d57 Mon Sep 17 00:00:00 2001
From: faust93 <monumentum@gmail.com>
Date: Thu, 14 Jul 2016 20:56:42 +0300
Subject: [PATCH] HIFI Settings [1/2]

---
 AndroidManifest.xml                                |  14 ++
 res/values/strings.xml                             |  11 +
 res/xml/hifi_sound_settings.xml                    |  63 +++++
 res/xml/sounds.xml                                 |   7 +
 src/com/android/settings/Settings.java             |   1 +
 src/com/android/settings/SettingsActivity.java     |   5 +-
 .../android/settings/hifi/HifiSoundSettings.java   | 277 +++++++++++++++++++++
 src/com/android/settings/search/Ranking.java       |   4 +
 .../settings/search/SearchIndexableResources.java  |   9 +
 9 files changed, 390 insertions(+), 1 deletion(-)
 create mode 100644 res/xml/hifi_sound_settings.xml
 create mode 100644 src/com/android/settings/hifi/HifiSoundSettings.java

diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 2ab3b3e..ecacbd6 100755
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -3181,6 +3181,20 @@
             </intent-filter>
         </activity>
 
+        <!-- Hifi settings activity. -->
+        <activity android:name="Settings$HifiSoundSettingsActivity"
+                android:label="@string/hifi_sound_title"
+                android:excludeFromRecents="true">
+            <intent-filter>
+                <action android:name="android.intent.action.MAIN" />
+                <category android:name="android.intent.category.DEFAULT" />
+            </intent-filter>
+            <meta-data android:name="com.android.settings.FRAGMENT_CLASS"
+                android:value="com.android.settings.hifi.HifiSoundSettings" />
+            <meta-data android:name="com.android.settings.TOP_LEVEL_HEADER_ID"
+                android:resource="@id/sound_settings" />
+        </activity>
+
     </application>
 </manifest>
 
diff --git a/res/values/strings.xml b/res/values/strings.xml
index 6680e0c..4250616 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -7063,4 +7063,15 @@
 
     <!-- Toast message letting the user know the color temperature setting is not immediate -->
     <string name="color_temperature_toast">To apply color change, turn off screen</string>
+
+   <!-- Title and summary for HiFi settings -->
+   <string name="hifi_sound_title">Hi-Fi settings</string>
+   <string name="hifi_sound_settings">Hifi sound settings</string>
+   <string name="hifi_enable_title">Enable ES9018 DAC</string>
+   <string name="hifi_impedance_title">HiFi Gain</string>
+   <string name="hifi_gain_auto_title">Auto Gain</string>
+   <string name="hifi_gain_low_title">Low Gain</string>
+   <string name="hifi_gain_high_title">High Gain</string>
+   <string name="hifi_gain_line_title">LineOut</string>
+
 </resources>
diff --git a/res/xml/hifi_sound_settings.xml b/res/xml/hifi_sound_settings.xml
new file mode 100644
index 0000000..b8af46e
--- /dev/null
+++ b/res/xml/hifi_sound_settings.xml
@@ -0,0 +1,63 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2014 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+
+<PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android"
+        android:title="@string/hifi_sound_settings"
+        android:key="hifi_sound_settings"
+        xmlns:settings="http://schemas.android.com/apk/res/com.android.settings">
+
+    <SwitchPreference
+            android:key="hifi_enable"
+            android:title="@string/hifi_enable_title"
+            android:switchTextOff=""
+            android:switchTextOn=""
+            android:persistent="false" />
+
+    <PreferenceCategory
+            android:key="hifi_impedance"
+            android:title="@string/hifi_impedance_title">
+
+    <SwitchPreference
+            android:key="hifi_gain_auto"
+            android:title="@string/hifi_gain_auto_title"
+            android:switchTextOff=""
+            android:switchTextOn=""
+            android:persistent="false" />
+
+    <SwitchPreference
+            android:key="hifi_gain_low"
+            android:title="@string/hifi_gain_low_title"
+            android:switchTextOff=""
+            android:switchTextOn=""
+            android:persistent="false" />
+
+    <SwitchPreference
+            android:key="hifi_gain_high"
+            android:title="@string/hifi_gain_high_title"
+            android:switchTextOff=""
+            android:switchTextOn=""
+            android:persistent="false" />
+
+    <SwitchPreference
+            android:key="hifi_gain_line"
+            android:title="@string/hifi_gain_line_title"
+            android:switchTextOff=""
+            android:switchTextOn=""
+            android:persistent="false" />
+
+    </PreferenceCategory>
+
+</PreferenceScreen>
diff --git a/res/xml/sounds.xml b/res/xml/sounds.xml
index 8b7dd46..33b25d3 100644
--- a/res/xml/sounds.xml
+++ b/res/xml/sounds.xml
@@ -106,6 +106,13 @@
                 android:title="@string/other_sound_settings"
                 android:persistent="false"
                 android:fragment="com.android.settings.notification.OtherSoundSettings" />
+
+        <!-- HiFi options -->
+        <Preference
+                android:key="hifi_sound_settings"
+                android:title="@string/hifi_sound_title"
+                android:persistent="false"
+                android:fragment="com.android.settings.hifi.HifiSoundSettings" />
     </PreferenceCategory>
 
     <PreferenceCategory
diff --git a/src/com/android/settings/Settings.java b/src/com/android/settings/Settings.java
index 8317660..ce39cdb 100644
--- a/src/com/android/settings/Settings.java
+++ b/src/com/android/settings/Settings.java
@@ -143,4 +143,5 @@ public class Settings extends SettingsActivity {
     public static class WeatherProviderServicesActivity extends SettingsActivity { /* empty */ }
     public static class AmbientDisplaySettingsActivity extends SettingsActivity { /* empty */ }
     public static class FloatingWindowActivity extends SettingsActivity { /* empty */ }
+    public static class HifiSoundSettingsActivity extends SettingsActivity { /* empty */ }
 }
diff --git a/src/com/android/settings/SettingsActivity.java b/src/com/android/settings/SettingsActivity.java
index cea17e8..bae18b0 100644
--- a/src/com/android/settings/SettingsActivity.java
+++ b/src/com/android/settings/SettingsActivity.java
@@ -148,6 +148,7 @@ import com.android.settings.wifi.AdvancedWifiSettings;
 import com.android.settings.wifi.SavedAccessPointsWifiSettings;
 import com.android.settings.wifi.WifiSettings;
 import com.android.settings.wifi.p2p.WifiP2pSettings;
+import com.android.settings.hifi.HifiSoundSettings;
 
 
 import cyanogenmod.app.CMContextConstants;
@@ -409,7 +410,9 @@ public class SettingsActivity extends Activity
             FlingSettings.class.getName(),
             SmartbarSettings.class.getName(),
             PulseSettings.class.getName(),
-            WeatherServiceSettings.class.getName()
+            WeatherServiceSettings.class.getName(),
+            HifiSoundSettings.class.getName()
+
     };
 
 
diff --git a/src/com/android/settings/hifi/HifiSoundSettings.java b/src/com/android/settings/hifi/HifiSoundSettings.java
new file mode 100644
index 0000000..b9e7f90
--- /dev/null
+++ b/src/com/android/settings/hifi/HifiSoundSettings.java
@@ -0,0 +1,277 @@
+/*
+ * Copyright (C) 2014 The Android Open Source Project
+ * Copyright (C) 2016 faust93 at monumentum@gmail.com
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.settings.hifi;
+
+import static com.android.settings.notification.SettingPref.TYPE_GLOBAL;
+import static com.android.settings.notification.SettingPref.TYPE_SYSTEM;
+
+import android.app.Activity;
+import android.content.ContentResolver;
+import android.content.Context;
+import android.content.Intent;
+import android.content.res.Resources;
+import android.database.ContentObserver;
+import android.media.AudioManager;
+import android.media.Ringtone;
+import android.media.RingtoneManager;
+import android.net.Uri;
+import android.os.Bundle;
+import android.os.Handler;
+import android.os.UserHandle;
+import android.preference.Preference;
+import android.preference.PreferenceScreen;
+import android.preference.SwitchPreference;
+import android.provider.SearchIndexableResource;
+import android.provider.Settings;
+import android.provider.Settings.Global;
+import android.provider.Settings.System;
+import android.util.Log;
+
+import com.android.internal.logging.MetricsLogger;
+
+import com.android.settings.R;
+import com.android.settings.SettingsPreferenceFragment;
+import com.android.settings.Utils;
+import com.android.settings.search.BaseSearchIndexProvider;
+import com.android.settings.search.Indexable;
+
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.List;
+
+public class HifiSoundSettings extends SettingsPreferenceFragment implements Preference.OnPreferenceChangeListener, Indexable {
+    private static final String TAG = "HifiSoundSettings";
+
+    private static final String HIFI_MODE = "hifi_mode";
+
+    private static final String KEY_HIFI_IMPEDANCE = "hifi_impedance";
+
+    private static final String KEY_HIFI_ENABLE = "hifi_enable";
+    private static final String KEY_HIFI_GAIN_AUTO = "hifi_gain_auto";
+    private static final String KEY_HIFI_GAIN_LOW = "hifi_gain_low";
+    private static final String KEY_HIFI_GAIN_HIGH = "hifi_gain_high";
+    private static final String KEY_HIFI_GAIN_LINE = "hifi_gain_line";
+
+    private AudioManager mAudioManager;
+
+    private int mHifiMode;
+    private int mHifiState;
+
+    private SwitchPreference mHifiEnable;
+    private SwitchPreference mHifiAuto;
+    private SwitchPreference mHifiLowGain;
+    private SwitchPreference mHifiHighGain;
+    private SwitchPreference mHifiLineOut;
+
+    @Override
+    protected int getMetricsCategory() {
+        return MetricsLogger.APPLICATION;
+    }
+
+    @Override
+    public void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+
+        mAudioManager = (AudioManager) getActivity().getSystemService("audio");
+
+        PreferenceScreen prefSet = getPreferenceScreen();
+
+        addPreferencesFromResource(R.xml.hifi_sound_settings);
+
+        mHifiMode = Settings.System.getIntForUser(getContentResolver(),
+                Settings.System.HIFI_MODE, 0, UserHandle.USER_CURRENT);
+
+        mHifiState = Settings.System.getIntForUser(getContentResolver(),
+                Settings.System.HIFI_ENABLE, 0, UserHandle.USER_CURRENT);
+
+        mHifiEnable = (SwitchPreference) findPreference(KEY_HIFI_ENABLE);
+        if(mHifiState!=0)
+            mHifiEnable.setChecked(true);
+        else
+            mHifiEnable.setChecked(false);
+
+        mHifiAuto = (SwitchPreference) findPreference(KEY_HIFI_GAIN_AUTO);
+        mHifiLowGain = (SwitchPreference) findPreference(KEY_HIFI_GAIN_LOW);
+        mHifiHighGain = (SwitchPreference) findPreference(KEY_HIFI_GAIN_HIGH);
+        mHifiLineOut = (SwitchPreference) findPreference(KEY_HIFI_GAIN_LINE);
+
+        mHifiEnable.setOnPreferenceChangeListener(this);
+        mHifiAuto.setOnPreferenceChangeListener(this);
+        mHifiLowGain.setOnPreferenceChangeListener(this);
+        mHifiHighGain.setOnPreferenceChangeListener(this);
+        mHifiLineOut.setOnPreferenceChangeListener(this);
+
+        if (mHifiState == 0) {
+            findPreference(KEY_HIFI_IMPEDANCE).setEnabled(false);
+        } else {
+            findPreference(KEY_HIFI_IMPEDANCE).setEnabled(true);
+        }
+
+        initMode(mHifiMode);
+    }
+
+    @Override
+    public void onResume() {
+        super.onResume();
+    }
+
+    @Override
+    public void onPause() {
+        super.onPause();
+    }
+
+    @Override
+    public boolean onPreferenceTreeClick(PreferenceScreen preferenceScreen, Preference preference) {
+        return super.onPreferenceTreeClick(preferenceScreen, preference);
+    }
+
+    public boolean onPreferenceChange(Preference preference, Object objValue) {
+        final String key = preference.getKey();
+
+        if (key.equals(KEY_HIFI_ENABLE)) {
+
+         if((Boolean)objValue){
+          mHifiState = 1;
+          mAudioManager.setParameters("hifi_state=on");
+         } else {
+          mHifiState = 0;
+          mAudioManager.setParameters("hifi_state=off");
+         }
+
+         Settings.System.putIntForUser(getContentResolver(),
+                    Settings.System.HIFI_ENABLE, (Boolean) objValue ? 1 : 0, UserHandle.USER_CURRENT);
+
+             if (mHifiState == 0) {
+                findPreference(KEY_HIFI_IMPEDANCE).setEnabled(false);
+             } else {
+                findPreference(KEY_HIFI_IMPEDANCE).setEnabled(true);
+             }
+
+        return true;
+        }
+
+        switch(key){
+            case KEY_HIFI_GAIN_AUTO:
+            case KEY_HIFI_GAIN_LOW:
+            case KEY_HIFI_GAIN_HIGH:
+            case KEY_HIFI_GAIN_LINE:
+            setMode(preference);
+        }
+        return true;
+    }
+
+    private void setMode(Preference preference) {
+        if (preference == mHifiAuto) {
+            if (!mHifiAuto.isChecked()) {
+                mHifiAuto.setChecked(true);
+                mHifiLowGain.setChecked(false);
+                mHifiHighGain.setChecked(false);
+                mHifiLineOut.setChecked(false);
+                System.putInt(getActivity().getContentResolver(), HIFI_MODE, 0);
+                mAudioManager.setParameters("hifi_gain=0");
+            }
+        } else if (preference == mHifiLowGain) {
+            if (!mHifiLowGain.isChecked()) {
+                mHifiAuto.setChecked(false);
+                mHifiLowGain.setChecked(true);
+                mHifiHighGain.setChecked(false);
+                mHifiLineOut.setChecked(false);
+                System.putInt(getActivity().getContentResolver(), HIFI_MODE, 1);
+                mAudioManager.setParameters("hifi_gain=1");
+            }
+        } else if (preference == mHifiHighGain) {
+            if (!mHifiHighGain.isChecked()) {
+                mHifiAuto.setChecked(false);
+                mHifiLowGain.setChecked(false);
+                mHifiHighGain.setChecked(true);
+                mHifiLineOut.setChecked(false);
+                checkAutoAdjustStreamVolume();
+                System.putInt(getActivity().getContentResolver(), HIFI_MODE, 2);
+                mAudioManager.setParameters("hifi_gain=2");
+            }
+        } else if (preference == mHifiLineOut && !mHifiLineOut.isChecked()) {
+            mHifiAuto.setChecked(false);
+            mHifiLowGain.setChecked(false);
+            mHifiHighGain.setChecked(false);
+            mHifiLineOut.setChecked(true);
+            System.putInt(getActivity().getContentResolver(), HIFI_MODE, 3);
+            mAudioManager.setParameters("hifi_gain=3");
+        }
+    }
+
+    private void checkAutoAdjustStreamVolume() {
+        if (mAudioManager.getStreamVolume(3) > 50) {
+            Log.d("HifiSettings", "checkAutoAdjustStreamVolume: auto set music_stream volume index: 50");
+            mAudioManager.setStreamVolume(3, 50, 0);
+        }
+    }
+
+    private void initMode(int mode) {
+        switch (mode) {
+            case 0:
+                mHifiAuto.setChecked(true);
+                mHifiLowGain.setChecked(false);
+                mHifiHighGain.setChecked(false);
+                mHifiLineOut.setChecked(false);
+                return;
+            case 1:
+                mHifiAuto.setChecked(false);
+                mHifiLowGain.setChecked(true);
+                mHifiHighGain.setChecked(false);
+                mHifiLineOut.setChecked(false);
+                return;
+            case 2:
+                this.mHifiAuto.setChecked(false);
+                this.mHifiLowGain.setChecked(false);
+                this.mHifiHighGain.setChecked(true);
+                this.mHifiLineOut.setChecked(false);
+                return;
+            case 3:
+                mHifiAuto.setChecked(false);
+                mHifiLowGain.setChecked(false);
+                mHifiHighGain.setChecked(false);
+                mHifiLineOut.setChecked(true);
+                return;
+            default:
+                Log.e("HifiSoundSettings", "HIFI_MODE:" + mode);
+                return;
+        }
+    }
+
+    public static final BaseSearchIndexProvider SEARCH_INDEX_DATA_PROVIDER =
+            new BaseSearchIndexProvider() {
+
+        public List<SearchIndexableResource> getXmlResourcesToIndex(
+                Context context, boolean enabled) {
+            final SearchIndexableResource sir = new SearchIndexableResource(context);
+            sir.xmlResId = R.xml.hifi_sound_settings;
+            return Arrays.asList(sir);
+        }
+
+        public List<String> getNonIndexableKeys(Context context) {
+            final ArrayList<String> rt = new ArrayList<String>();
+//            for (SettingPref pref : PREFS) {
+//                if (!pref.isApplicable(context)) {
+//                    rt.add(pref.getKey());
+//                }
+//            }
+            return rt;
+        }
+    };
+
+}
diff --git a/src/com/android/settings/search/Ranking.java b/src/com/android/settings/search/Ranking.java
index 06d0862..e295cd1 100644
--- a/src/com/android/settings/search/Ranking.java
+++ b/src/com/android/settings/search/Ranking.java
@@ -77,6 +77,8 @@ import com.android.settings.users.UserSettings;
 import com.android.settings.wifi.AdvancedWifiSettings;
 import com.android.settings.wifi.SavedAccessPointsWifiSettings;
 import com.android.settings.wifi.WifiSettings;
+import com.android.settings.hifi.HifiSoundSettings;
+
 
 import java.util.HashMap;
 
@@ -132,6 +134,8 @@ public final class Ranking {
     public static final int RANK_RR_SMARTBAR = 45;
     public static final int RANK_RR_SBCOLOR = 46;
     public static final int RANK_RR_QSPANEL= 47;
+    public static final int RANK_HIFI = 51;
+
     public static final int RANK_UNDEFINED = -1;
     public static final int RANK_OTHERS = 1024;
     public static final int BASE_RANK_DEFAULT = 2048;
diff --git a/src/com/android/settings/search/SearchIndexableResources.java b/src/com/android/settings/search/SearchIndexableResources.java
index 1d8c116..869cf3e 100644
--- a/src/com/android/settings/search/SearchIndexableResources.java
+++ b/src/com/android/settings/search/SearchIndexableResources.java
@@ -78,6 +78,8 @@ import com.android.settings.users.UserSettings;
 import com.android.settings.wifi.AdvancedWifiSettings;
 import com.android.settings.wifi.SavedAccessPointsWifiSettings;
 import com.android.settings.wifi.WifiSettings;
+import com.android.settings.hifi.HifiSoundSettings;
+
 
 import java.util.Collection;
 import java.util.HashMap;
@@ -514,6 +516,13 @@ public final class SearchIndexableResources {
                         NO_DATA_RES_ID,
                         StatusBarColors.class.getName(),
                         R.drawable.rr_quick_settings_icon));
+
+        sResMap.put(HifiSoundSettings.class.getName(),
+                new SearchIndexableResource(
+                        Ranking.getRankForClassName(HifiSoundSettings.class.getName()),
+                        NO_DATA_RES_ID,
+                        HifiSoundSettings.class.getName(),
+                        R.drawable.ic_settings_notifications));
     }
 
     private SearchIndexableResources() {
-- 
1.9.3 (Apple Git-50)

